<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>app/models/loan.rb</title>
    <link href="screen.css" media="all" rel="stylesheet" type="text/css" />
    <link href="print.css" media="print" rel="stylesheet" type="text/css" />
    
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <script type="text/javascript" src="rcov.js"></script>
  </head>
  <body>
    <h1>Mostfit C0 Coverage Information - RCov</h1>
    <h2>app/models/loan.rb</h2>

    

    <div class="report_table_wrapper">
      <table class='report' id='report_table'>
        <thead>
          <tr>
            <th class="left_align">Name</th>
            <th class="right_align">Total Lines</th>
            <th class="right_align">Lines of Code</th>
            <th class="left_align">Total Coverage</th>
            <th class="left_align">Code Coverage</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="left_align"><a href="app-models-loan_rb.html">app/models/loan.rb</a></td>
            <td class='right_align'><tt>821</tt></td>
            <td class='right_align'><tt>645</tt></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>79.90%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:80px"></div>
            <div class="uncovered" style="width:20px"></div>
          </div></td>
            <td class="left_align"><div class="percent_graph_legend"><tt class=''>76.28%</tt></div>
          <div class="percent_graph">
            <div class="covered" style="width:76px"></div>
            <div class="uncovered" style="width:24px"></div>
          </div></td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <h3>Key</h3>
    
    <div class="key"><pre><span class='marked'>Code reported as executed by Ruby looks like this...</span><span class='marked1'>and this: this line is also marked as covered.</span><span class='inferred'>Lines considered as run by rcov, but not reported by Ruby, look like this,</span><span class='inferred1'>and this: these lines were inferred by rcov (using simple heuristics).</span><span class='uncovered'>Finally, here's a line marked as not executed.</span></pre></div>

    <h3>Coverage Details</h3>

    <table class="details">
      <tbody>
        
          
          
          <tr class="marked">
            <td><pre><a name="line1">1</a> class Loan</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line2">2</a>   include DataMapper::Resource</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line3">3</a>   before :valid?,  :parse_dates</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line4">4</a>   after  :save,    :update_history  # also seems to do updates</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line5">5</a>   after  :destroy, :update_history</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line6">6</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line7">7</a>   attr_accessor :history_disabled  # set to true to disable history writing by this object</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line8">8</a>   attr_accessor :interest_percentage  # set to true to disable history writing by this object</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line9">9</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line10">10</a>   property :id,                             Serial</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line11">11</a>   property :discriminator,                  Discriminator, :nullable =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line12">12</a>   property :amount,                         Integer, :nullable =&gt; false, :index =&gt; true  # see helper for formatting</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line13">13</a>   property :interest_rate,                  Float, :nullable =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line14">14</a>   property :installment_frequency,          Enum.send('[]', *INSTALLMENT_FREQUENCIES), :nullable =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line15">15</a>   property :number_of_installments,         Integer, :nullable =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line16">16</a>   property :scheduled_disbursal_date,       Date, :nullable =&gt; false, :auto_validation =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line17">17</a>   property :scheduled_first_payment_date,   Date, :nullable =&gt; false, :auto_validation =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line18">18</a>   property :applied_on,                     Date, :nullable =&gt; false, :auto_validation =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line19">19</a>   property :approved_on,                    Date, :auto_validation =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line20">20</a>   property :rejected_on,                    Date, :auto_validation =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line21">21</a>   property :disbursal_date,                 Date, :auto_validation =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line22">22</a>   property :written_off_on,                 Date, :auto_validation =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line23">23</a>   property :fees,                           Yaml, :length =&gt; 20000  # like: &quot;first fee: 1000, second fee: 200&quot; (yaml) -- fully reimplementable</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line24">24</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line25">25</a>   property :fees_total,                     Integer, :default =&gt; 0, :index =&gt; true  # gets included in first payment</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line26">26</a>   property :fees_paid,                      Boolean, :default =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line27">27</a>   property :validated_on,                   Date, :auto_validation =&gt; false, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line28">28</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line29">29</a>   property :validation_comment,             Text</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line30">30</a>   property :created_at,                     DateTime, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line31">31</a>   property :updated_at,                     DateTime, :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line32">32</a>   property :loan_product_id,                Integer,  :index =&gt; true</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line33">33</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line34">34</a>   property :applied_by_staff_id,            Integer, :nullable =&gt; true, :index =&gt; true </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line35">35</a>   property :approved_by_staff_id,           Integer, :nullable =&gt; true, :index =&gt; true </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line36">36</a>   property :rejected_by_staff_id,           Integer, :nullable =&gt; true, :index =&gt; true </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line37">37</a>   property :disbursed_by_staff_id,          Integer, :nullable =&gt; true, :index =&gt; true </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line38">38</a>   property :written_off_by_staff_id,        Integer, :nullable =&gt; true, :index =&gt; true </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line39">39</a>   property :validated_by_staff_id,          Integer, :nullable =&gt; true, :index =&gt; true </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line40">40</a>   # associations</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line41">41</a>   belongs_to :client</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line42">42</a>   belongs_to :funding_line</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line43">43</a>   belongs_to :applied_by,     :child_key =&gt; [:applied_by_staff_id],     :model =&gt; 'StaffMember'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line44">44</a>   belongs_to :approved_by,    :child_key =&gt; [:approved_by_staff_id],    :model =&gt; 'StaffMember'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line45">45</a>   belongs_to :rejected_by,    :child_key =&gt; [:rejected_by_staff_id],    :model =&gt; 'StaffMember'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line46">46</a>   belongs_to :disbursed_by,   :child_key =&gt; [:disbursed_by_staff_id],   :model =&gt; 'StaffMember'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line47">47</a>   belongs_to :written_off_by, :child_key =&gt; [:written_off_by_staff_id], :model =&gt; 'StaffMember'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line48">48</a>   belongs_to :validated_by,   :child_key =&gt; [:validated_by_staff_id],   :model =&gt; 'StaffMember'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line49">49</a>   has n, :payments</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line50">50</a>   has n, :history, :model =&gt; 'LoanHistory'</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line51">51</a>   belongs_to :loan_product</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line52">52</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line53">53</a>   validates_with_method  :amount,                       :method =&gt; :amount_greater_than_zero?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line54">54</a>   validates_with_method  :amount,                       :method =&gt; :installments_are_integers?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line55">55</a>   validates_with_method  :interest_rate,                :method =&gt; :interest_rate_greater_than_zero?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line56">56</a>   validates_with_method  :number_of_installments,       :method =&gt; :number_of_installments_greater_than_zero?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line57">57</a>   validates_with_method  :applied_on,                   :method =&gt; :applied_before_appoved?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line58">58</a>   validates_with_method  :approved_on,                  :method =&gt; :applied_before_appoved?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line59">59</a>   validates_with_method  :applied_on,                   :method =&gt; :applied_before_rejected?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line60">60</a>   validates_with_method  :rejected_on,                  :method =&gt; :applied_before_rejected?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line61">61</a>   validates_with_method  :approved_on,                  :method =&gt; :approved_before_disbursed?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line62">62</a>   validates_with_method  :disbursal_date,               :method =&gt; :approved_before_disbursed?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line63">63</a>   validates_with_method  :disbursal_date,               :method =&gt; :disbursed_before_written_off?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line64">64</a>   validates_with_method  :written_off_on,               :method =&gt; :disbursed_before_written_off?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line65">65</a>   validates_with_method  :disbursal_date,               :method =&gt; :disbursed_before_validated?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line66">66</a>   validates_with_method  :validated_on,                 :method =&gt; :disbursed_before_validated?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line67">67</a>   validates_with_method  :approved_on,                  :method =&gt; :applied_before_scheduled_to_be_disbursed?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line68">68</a>   validates_with_method  :scheduled_disbursal_date,     :method =&gt; :applied_before_scheduled_to_be_disbursed?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line69">69</a>   validates_with_method  :approved_on,                  :method =&gt; :properly_approved?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line70">70</a>   validates_with_method  :approved_by,                  :method =&gt; :properly_approved?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line71">71</a>   validates_with_method  :rejected_on,                  :method =&gt; :properly_rejected?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line72">72</a>   validates_with_method  :rejected_by,                  :method =&gt; :properly_rejected?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line73">73</a>   validates_with_method  :written_off_on,               :method =&gt; :properly_written_off?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line74">74</a>   validates_with_method  :written_off_by,               :method =&gt; :properly_written_off?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line75">75</a>   validates_with_method  :disbursal_date,               :method =&gt; :properly_disbursed?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line76">76</a>   validates_with_method  :disbursed_by,                 :method =&gt; :properly_disbursed?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line77">77</a>   validates_with_method  :validated_on,                 :method =&gt; :properly_validated?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line78">78</a>   validates_with_method  :validated_by,                 :method =&gt; :properly_validated?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line79">79</a>   validates_with_method  :scheduled_first_payment_date, :method =&gt; :scheduled_disbursal_before_scheduled_first_payment?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line80">80</a>   validates_with_method  :scheduled_disbursal_date,     :method =&gt; :scheduled_disbursal_before_scheduled_first_payment?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line81">81</a>   validates_present      :client, :funding_line, :scheduled_disbursal_date, :scheduled_first_payment_date, :applied_by, :applied_on</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line82">82</a>   </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line83">83</a>   #product validations</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line84">84</a>   validates_with_method  :amount,                       :method =&gt; :is_valid_loan_product_amount</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line85">85</a>   validates_with_method  :interest_rate,                :method =&gt; :is_valid_loan_product_interest_rate</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line86">86</a>   validates_with_method  :number_of_installments,       :method =&gt; :is_valid_loan_product_number_of_installments</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line87">87</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line88">88</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line89">89</a>   def self.from_csv(row, headers, funding_lines)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line90">90</a>     obj = new(:loan_product_id =&gt; LoanProduct.first(:name =&gt; row[headers[:product]]).id, :amount =&gt; row[headers[:amount]], </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line91">91</a>               :interest_rate =&gt; row[headers[:interest_rate]], </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line92">92</a>               :installment_frequency =&gt; row[headers[:installment_frequency]], :number_of_installments =&gt; row[headers[:number_of_installments]], </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line93">93</a>               :scheduled_disbursal_date =&gt; Date.parse(row[headers[:scheduled_disbursal_date]]), </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line94">94</a>               :scheduled_first_payment_date =&gt; Date.parse(row[headers[:scheduled_first_payment_date]]), </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line95">95</a>               :applied_on =&gt; Date.parse(row[headers[:applied_on]]), :approved_on =&gt; Date.parse(row[headers[:approved_on]]), </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line96">96</a>               :disbursal_date =&gt; Date.parse(row[headers[:disbursal_date]]), :fees =&gt; row[headers[:fees]], :fees_total =&gt; row[headers[:fees_total]],</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line97">97</a>               :disbursed_by_staff_id =&gt; StaffMember.first(:name =&gt; row[headers[:disbursed_by_staff]]).id, </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line98">98</a>               :funding_line_id =&gt; funding_lines[row[headers[:funding_line_serial_number]]].id,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line99">99</a>               :applied_by_staff_id =&gt; StaffMember.first(:name =&gt; row[headers[:applied_by_staff]]).id,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line100">100</a>               :approved_by_staff_id =&gt; StaffMember.first(:name =&gt; row[headers[:approved_by_staff]]).id,</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line101">101</a>               :client_id =&gt; Client.first(:reference =&gt; row[headers[:client_reference]]).id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line102">102</a>     obj.history_disabled=true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line103">103</a>     [obj.save, obj]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line104">104</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line105">105</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line106">106</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line107">107</a>   def is_valid_loan_product_amount; is_valid_loan_product(:amount); end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line108">108</a>   def is_valid_loan_product_interest_rate; is_valid_loan_product(:interest_rate); end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line109">109</a>   def is_valid_loan_product_number_of_installments; is_valid_loan_product(:number_of_installments); end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line110">110</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line111">111</a>   def is_valid_loan_product(method)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line112">112</a>     return true unless self.loan_product</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line113">113</a>     product = self.loan_product</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line114">114</a>     {:min =&gt; :minimum, :max =&gt; :maximum}.each{|k, v|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line115">115</a>       loan_attr    = self.send(method)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line116">116</a>       product_attr = product.send(&quot;#{k}_#{method}&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line117">117</a>       product_attr = product_attr.to_f/100 if method==:interest_rate</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line118">118</a>       if k==:min and loan_attr and product_attr and  loan_attr &lt; product_attr</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line119">119</a>         return [false, &quot;#{v.to_s.capitalize} #{method.to_s.humanize} limit violated&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line120">120</a>       elsif k==:max and loan_attr and product_attr and  loan_attr &gt; product_attr</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line121">121</a>         return  [false, &quot;#{v.to_s.capitalize} #{method.to_s.humanize} limit violated&quot;] </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line122">122</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line123">123</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line124">124</a>     return true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line125">125</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line126">126</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line127">127</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line128">128</a>   # MISC FUNCTIONS</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line129">129</a>   def self.search(q)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line130">130</a>     if /^\d+$/.match(q)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line131">131</a>       all(:conditions =&gt; {:id =&gt; q})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line132">132</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line133">133</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line134">134</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line135">135</a>   def clear_cache</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line136">136</a>     @payments_cache, @schedule, @history_array = nil</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line137">137</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line138">138</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line139">139</a>   # this method returns the last date the loan history makes sense</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line140">140</a>   # used by +update_history+ for knowing when to stop.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line141">141</a>   # (note: this is often a date in the future -- huh?!)   MAYBE: move this to the LoanHistory</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line142">142</a>   def last_loan_history_date</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line143">143</a>     s = get_status  # TODO: replace with case-when constuct</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line144">144</a>     return nil if s.nil?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line145">145</a>     if s == :approved</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line146">146</a>       return scheduled_repaid_on</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line147">147</a>     elsif s == :outstanding</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line148">148</a>       return [scheduled_repaid_on, Date.today].max</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line149">149</a>     elsif s == :repaid</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line150">150</a>       last_payment_received_on = self.payments.first(:order =&gt; [:received_on.desc]).received_on</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line151">151</a>       return [scheduled_repaid_on, last_payment_received_on].max</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line152">152</a>     elsif s == :written_off</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line153">153</a>       return [scheduled_repaid_on, written_off_on].max</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line154">154</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line155">155</a>     return nil  # i.e. when status is :applied or :rejected</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line156">156</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line157">157</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line158">158</a>   def repayment_style</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line159">159</a>     :allow_both   # one of [:separated, :aggregated, :allow_both]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line160">160</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line161">161</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line162">162</a>   def interest_percentage  # code dup with the FundingLine</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line163">163</a>     return nil if interest_rate.blank?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line164">164</a>     format(&quot;%.2f&quot;, interest_rate * 100)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line165">165</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line166">166</a>   def interest_percentage= (percentage)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line167">167</a>     self.interest_rate = percentage.to_f/100</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line168">168</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line169">169</a>   # returns the name of the funder</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line170">170</a>   def funder_name</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line171">171</a>     self.funding_line and self.funding_line.funder.name or nil</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line172">172</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line173">173</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line174">174</a>   # the arithmic of shifting by the installment_frequency (especially months is tricky)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line175">175</a>   # used by many other methods, it accepts a negative +number+</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line176">176</a>   # TODO: decide if we should make sure returned date is a payment date.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line177">177</a>   def shift_date_by_installments(date, number, ensure_meeting_day = true)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line178">178</a>     return date if number == 0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line179">179</a>     case installment_frequency</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line180">180</a>       when :daily</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line181">181</a>         new_date =  date + number</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line182">182</a>       when :weekly</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line183">183</a>         new_date =  date + number * 7</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line184">184</a>       when :biweekly</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line185">185</a>         new_date = date + number * 14</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line186">186</a>       when :monthly</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line187">187</a>         new_month = date.month + number</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line188">188</a>         new_year  = date.year</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line189">189</a>         while new_month &gt; 12</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line190">190</a>           new_year  += 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line191">191</a>           new_month -= 12</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line192">192</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line193">193</a>         while new_month &lt; 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line194">194</a>           new_year  -= 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line195">195</a>           new_month += 12</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line196">196</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line197">197</a>         month_lengths = [nil, 31, (Time.gm(new_year, new_month).to_date.leap? ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line198">198</a>         new_day = (date.day &gt; month_lengths[new_month]) ? month_lengths[new_month] : date.day</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line199">199</a>         new_date = Time.gm(new_year, new_month, new_day).to_date</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line200">200</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line201">201</a>         raise ArgumentError.new(&quot;Strange period you got..&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line202">202</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line203">203</a>     if self.client and self.client.center and self.client.center.meeting_day != :none and ensure_meeting_day</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line204">204</a>       next_meeting_day = client.center.next_meeting_date_from(new_date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line205">205</a>       new_date = next_meeting_day unless new_date.weekday == client.center.meeting_day</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line206">206</a>       #new_date - new_date.cwday + Center.meeting_days.index(client.center.meeting_day)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line207">207</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line208">208</a>       new_date</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line209">209</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line210">210</a>     new_date</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line211">211</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line212">212</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line213">213</a>   def self.description</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line214">214</a>     &quot;This is the description of the build-in master loan type. Typically you only deal with loan that are derived of this loan type.&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line215">215</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line216">216</a>   def fields_partial; ''; end  # without reimplementation in the descendants these will render the default shizzle</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line217">217</a>   def show_partial;   ''; end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line218">218</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line219">219</a>   def self.installment_frequencies</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line220">220</a>     # Loan.properties[:installment_frequency].type.flag_map.values would give us a garbled order, so:</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line221">221</a>     INSTALLMENT_FREQUENCIES</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line222">222</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line223">223</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line224">224</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line225">225</a>   # LOAN MANIPULATION FUNCTIONS</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line226">226</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line227">227</a>   # this is the method used for creating payments, not directly on the Payment class</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line228">228</a>   # for +input+ it allows either a &quot;total&quot; amount as Fixnum or an array with</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line229">229</a>   # principal[0] and interest[1].</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line230">230</a>   def repay(input, user, received_on, received_by, defer_update = false)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line231">231</a>     # this is the way to repay loans, _not_ directly on the Payment model</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line232">232</a>     # this to allow validations on the Payment to be implemented in (subclasses of) the Loan</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line233">233</a>     unless input.is_a? Array or input.is_a? Fixnum</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line234">234</a>       raise &quot;the input argument of Loan#repay should be of class Fixnum or Array&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line235">235</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line236">236</a>     raise &quot;cannot repay a loan that has not been saved&quot; if new?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line237">237</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line238">238</a>     principal, interest, total = 0, 0, nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line239">239</a>     if input.is_a? Fixnum  # in case only one amount is specified</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line240">240</a>       # interest is paid first, the rest goes in as principal</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line241">241</a>       # the payment is filed on received_on without knowing about the future</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line242">242</a>       # it could happen that payment have been made after this payment</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line243">243</a>       # here the validations on the Payment should </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line244">244</a>       total        = input</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line245">245</a>       interest_due = [(-interest_overpaid_on(received_on)), 0].max</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line246">246</a>       interest     = [interest_due, total].min  # never more than total</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line247">247</a>       principal    = total - interest</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line248">248</a>     elsif input.is_a? Array  # in case principal and interest are specified separately</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line249">249</a>       principal, interest = input[0].to_i, input[1].to_i</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line250">250</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line251">251</a>     payment = Payment.new(:loan =&gt; self, :created_by =&gt; user,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line252">252</a>       :received_on =&gt; received_on, :received_by =&gt; received_by,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line253">253</a>       :principal =&gt; principal.round, :interest =&gt; interest.round)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line254">254</a>     save_status = payment.save</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line255">255</a>     if save_status == true</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line256">256</a>       if defer_update #i.e. bulk updating loans</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line257">257</a>         Merb.run_later do</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line258">258</a>           update_history</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line259">259</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line260">260</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line261">261</a>         update_history  # update the history if we saved a payment</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line262">262</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line263">263</a>       clear_cache</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line264">264</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line265">265</a>     payment.principal, payment.interest = nil, nil unless total.nil?  # remove calculated pr./int. values from the form</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line266">266</a>     # Merb.logger.info &quot;loan #{id}: #{received_on} =&gt; paid #{principal} + #{interest} | prin_paid #{principal_received_up_to(received_on)} | os_bal:#{actual_outstanding_principal_on(received_on)}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line267">267</a>     [save_status, payment]  # return the success boolean and the payment object itself for further processing</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line268">268</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line269">269</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line270">270</a>   # the way to delete payments from the db</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line271">271</a>   def delete_payment(payment, user)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line272">272</a>     return false unless payment.loan.id == self.id</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line273">273</a>     if payment.update_attributes(:deleted_at =&gt; Time.now, :deleted_by_user_id =&gt; user.id)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line274">274</a>       update_history</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line275">275</a>       clear_cache</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line276">276</a>       return true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line277">277</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line278">278</a>     p payment.errors</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line279">279</a>     false</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line280">280</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line281">281</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line282">282</a>   # LOAN INFO FUNCTIONS - CALCULATIONS</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line283">283</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line284">284</a>   def payment_schedule</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line285">285</a>     return @schedule if @schedule</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line286">286</a>     @schedule = {}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line287">287</a>     principal_so_far, interest_so_far, total = 0, 0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line288">288</a>     balance = amount</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line289">289</a>     @schedule[disbursal_date || scheduled_disbursal_date] = {:principal =&gt; 0, :interest =&gt; 0, :total_principal =&gt; 0, :total_interest =&gt; 0,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line290">290</a>       :balance =&gt; balance, :total =&gt; 0}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line291">291</a>     (1..number_of_installments).each do |number|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line292">292</a>       date      = shift_date_by_installments(scheduled_first_payment_date, number - 1)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line293">293</a>       principal = scheduled_principal_for_installment(number)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line294">294</a>       interest  = scheduled_interest_for_installment(number)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line295">295</a>       principal_so_far += principal</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line296">296</a>       interest_so_far  += interest</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line297">297</a>       balance -= principal</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line298">298</a>       @schedule[date] = {</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line299">299</a>         :principal                  =&gt; principal,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line300">300</a>         :interest                   =&gt; interest,</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line301">301</a>         :total_principal            =&gt; (principal_so_far),</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line302">302</a>         :total_interest             =&gt; (interest_so_far),</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line303">303</a>         :total                      =&gt; principal_so_far + interest_so_far,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line304">304</a>         :balance                    =&gt; balance, </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line305">305</a>       }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line306">306</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line307">307</a>     # we have to do the following to avoid the circular reference from total_to_be_received.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line308">308</a>     total = @schedule[@schedule.keys.max][:total]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line309">309</a>     @schedule.each { |k,v| v[:total_balance] = total - v[:total]}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line310">310</a>     @schedule</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line311">311</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line312">312</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line313">313</a>   def payments_hash</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line314">314</a>     return @payments_cache if @payments_cache</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line315">315</a>     sql = %Q{</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line316">316</a>       SELECT sum(principal) as principal, sum(interest) as interest, received_on</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line317">317</a>         FROM payments</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line318">318</a>        WHERE (deleted_at IS NULL) AND (loan_id = #{self.id})</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line319">319</a>        GROUP BY received_on</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line320">320</a>     ORDER BY received_on}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line321">321</a>     structs = id ? repository.adapter.query(sql) : []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line322">322</a>     @payments_cache = {}</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line323">323</a>     total_balance = total_to_be_received</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line324">324</a>     @payments_cache[disbursal_date || scheduled_disbursal_date] = {</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line325">325</a>       :principal =&gt; 0, :interest =&gt; 0, :total_principal =&gt; 0, :total_interest =&gt; 0, :total =&gt; 0, :balance =&gt; amount, :total_balance =&gt; total_balance</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line326">326</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line327">327</a>     principal, interest, total = 0, 0, 0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line328">328</a>     structs.each do |payment|</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line329">329</a>       # we know the received_on dates are in ascending order as we</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line330">330</a>       # walk through (so we can do the += thingy)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line331">331</a>       </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line332">332</a>       @payments_cache[payment.received_on] = {</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line333">333</a>         :principal                 =&gt; payment.principal.to_i,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line334">334</a>         :interest                  =&gt; payment.interest.to_i,</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line335">335</a>         :total_principal           =&gt; (principal += payment.principal.to_i),</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line336">336</a>         :total_interest            =&gt; (interest  += payment.interest.to_i),</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line337">337</a>         :total                     =&gt; (total     +=payment.principal.to_i + payment.interest.to_i),</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line338">338</a>         :balance                   =&gt; amount - principal,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line339">339</a>         :total_balance             =&gt; total_balance - total}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line340">340</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line341">341</a>     dates = (installment_dates + payment_dates)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line342">342</a>     dates = dates.uniq.sort.reject{|d| d &lt;= structs[-1].received_on} unless structs.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line343">343</a>     dates.each do |date| </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line344">344</a>       @payments_cache[date] = {:principal =&gt; 0, :interest =&gt; 0, :total_principal =&gt; principal, :total_interest =&gt; interest, :total =&gt; total, :balance =&gt; amount - principal, :total_balance =&gt; total_balance - total}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line345">345</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line346">346</a>     @payments_cache</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line347">347</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line348">348</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line349">349</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line350">350</a>   # TODO these should logically be private. </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line351">351</a>   def get_from_cache(cache, column, date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line352">352</a>     date = Date.parse(date) if date.is_a? String</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line353">353</a>     return 0 if cache.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line354">354</a>     if cache.has_key?(date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line355">355</a>       return (column == :all ? cache[date] : cache[date][column])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line356">356</a>     else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line357">357</a>       return 0 if (column == :principal or column == :interest)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line358">358</a>       keys = cache.keys.sort</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line359">359</a>       if date &lt; keys.min</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line360">360</a>         rv = (column == :all ? cache[keys.min] : cache[keys.min][column]) </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line361">361</a>       elsif date &gt;= keys.max</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line362">362</a>         rv = (column == :all ? cache[keys.max] : cache[keys.max][column])</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line363">363</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line364">364</a>         keys.each_with_index do |k,i| </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line365">365</a>           if keys[[i+1,keys.size - 1].min] &gt; date</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line366">366</a>             rv = (column == :all ? cache[k] : cache[k][column]) </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line367">367</a>             break</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line368">368</a>           end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line369">369</a>         end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line370">370</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line371">371</a>       if rv.is_a? Hash</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line372">372</a>         rv[:principal] = 0; rv[:interest] = 0</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line373">373</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line374">374</a>       rv</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line375">375</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line376">376</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line377">377</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line378">378</a>   def get_scheduled(column, date) # helper function for readable functions below. make private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line379">379</a>     payment_schedule if @schedule.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line380">380</a>     get_from_cache(payment_schedule, column, date)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line381">381</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line382">382</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line383">383</a>   def get_actual(column, date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line384">384</a>     payments_hash if @payments_cache.nil?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line385">385</a>     get_from_cache(payments_hash, column, date)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line386">386</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line387">387</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line388">388</a>   # LOAN INFO FUNCTIONS - SCHEDULED</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line389">389</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line390">390</a>   # these 2 methods define the pay back scheme</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line391">391</a>   # These are ONE BASED</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line392">392</a>   # typically reimplemented in subclasses</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line393">393</a>   def scheduled_principal_for_installment(number)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line394">394</a>     # number unused in this implentation, subclasses may decide differently</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line395">395</a>     # therefor always supply number, so it works for all implementations</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line396">396</a>     raise &quot;number out of range, got #{number}&quot; if number &lt; 1 or number &gt; number_of_installments</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line397">397</a>     amount.to_f / number_of_installments</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line398">398</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line399">399</a>   def scheduled_interest_for_installment(number)  # typically reimplemented in subclasses</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line400">400</a>     # number unused in this implentation, subclasses may decide differently</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line401">401</a>     # therefor always supply number, so it works for all implementations</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line402">402</a>     raise &quot;number out of range, got #{number}&quot; if number &lt; 1 or number &gt; number_of_installments</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line403">403</a>     (amount * interest_rate / number_of_installments).to_i</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line404">404</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line405">405</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line406">406</a>   # These info functions need not be overridden in derived classes.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line407">407</a>   # We attmept to achieve speed by caching values for the duration of a request through a payment_schedule function</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line408">408</a>   # Later we write functions for</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line409">409</a>   #    scheduled_[principal, interest, total]_to_be_received</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line410">410</a>   #    scheduled_[principal, interest, total]_up_to(date)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line411">411</a>   #    scheduled_[principal, interest, total]_on(date)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line412">412</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line413">413</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line414">414</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line415">415</a>   def total_principal_to_be_received; get_scheduled(:total_principal, self.scheduled_maturity_date).to_i; end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line416">416</a>   def total_interest_to_be_received; get_scheduled(:total_interest, self.scheduled_maturity_date).to_i; end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line417">417</a>   def total_to_be_received; total_principal_to_be_received.to_i + total_interest_to_be_received.to_i; end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line418">418</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line419">419</a>   def scheduled_principal_up_to(date); get_scheduled(:total_principal, date).to_i; end </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line420">420</a>   def scheduled_interest_up_to(date);  get_scheduled(:total_interest,  date).to_i; end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line421">421</a>   def scheduled_total_up_to(date); scheduled_principal_up_to(date).to_i + scheduled_interest_up_to(date).to_i;  end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line422">422</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line423">423</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line424">424</a>   def scheduled_principal_due_on(date); get_scheduled(:principal, date).to_i; end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line425">425</a>   def scheduled_interest_due_on(date); get_scheduled(:interest, date).to_i; end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line426">426</a>   def scheduled_total_due_on(date); scheduled_principal_due_on(dqte) + scheduled_interest_due_on(date); end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line427">427</a>   # these 3 methods return scheduled amounts from a LOAN-OUTSTANDING perspective</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line428">428</a>   # they are purely calculated -- no calls to its payments or loan_history)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line429">429</a>   def scheduled_outstanding_principal_on(date)  # typically reimplemented in subclasses</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line430">430</a>     return 0 if date &lt; applied_on</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line431">431</a>     return amount if  date &lt; (disbursal_date || scheduled_disbursal_date)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line432">432</a>     amount - scheduled_principal_up_to(date)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line433">433</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line434">434</a>   def scheduled_outstanding_interest_on(date)  # typically reimplemented in subclasses</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line435">435</a>     return 0 if date &lt; applied_on</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line436">436</a>     return total_interest_to_be_received if date &lt; (disbursal_date || scheduled_disbursal_date)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line437">437</a>     total_interest_to_be_received - scheduled_interest_up_to(date)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line438">438</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line439">439</a>   def scheduled_outstanding_total_on(date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line440">440</a>     return 0 if date &lt; applied_on</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line441">441</a>     return total_to_be_received if date &lt; (disbursal_date || scheduled_disbursal_date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line442">442</a>     total_to_be_received - scheduled_total_up_to(date)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line443">443</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line444">444</a>   # the number of payment dates before 'date' (if date is a payment 'date' it is counted in)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line445">445</a>   # used to calculate the outstanding value, and in the views</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line446">446</a>   def number_of_installments_before(date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line447">447</a>     return 0 if date &lt; scheduled_first_payment_date</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line448">448</a>     result = case installment_frequency</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line449">449</a>       when  :daily</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line450">450</a>       then  (date - scheduled_first_payment_date).to_f.floor + 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line451">451</a>       when  :weekly</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line452">452</a>       then  ((date - scheduled_first_payment_date).to_f / 7).floor + 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line453">453</a>       when  :biweekly</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line454">454</a>       then  ((date - scheduled_first_payment_date).to_f / 14).floor + 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line455">455</a>       when  :monthly</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line456">456</a>       then  count = 1</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line457">457</a>             count += 1 while shift_date_by_installments(date, -count) &gt;= scheduled_first_payment_date</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line458">458</a>             count</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line459">459</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line460">460</a>         raise ArgumentError.new(&quot;Strange period you got..&quot;)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line461">461</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line462">462</a>     [result, number_of_installments].min  # never return more than the number_of_installments</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line463">463</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line464">464</a>   </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line465">465</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line466">466</a>   # LOAN INFO FUNCTIONS - ACTUALS</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line467">467</a>   # the following methods basically count the payments (PAYMENT-RECEIVED perspective)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line468">468</a>   # the last method makes the actual (optimized) db call and is cached</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line469">469</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line470">470</a>   def principal_received_up_to(date); get_actual(:total_principal, date); end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line471">471</a>   def interest_received_up_to(date); get_actual(:total_interest, date); end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line472">472</a>   def total_received_up_to(date); get_actual(:total,date); end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line473">473</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line474">474</a>   def principal_received_on(date); get_actual(:principal, date); end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line475">475</a>   def interest_received_on(date); get_actual(:interest, date); end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line476">476</a>   def total_received_on(date); principal_received_on(date) + interest_received_on(date); end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line477">477</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line478">478</a>   # these 3 methods return overpayment amounts (PAYMENT-RECEIVED perspective)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line479">479</a>   # negative values mean shortfall (we're positive-minded at intellecap)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line480">480</a>   def principal_overpaid_on(date)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line481">481</a>     (principal_received_up_to(date) - scheduled_principal_up_to(date)).to_i</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line482">482</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line483">483</a>   def interest_overpaid_on(date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line484">484</a>     (interest_received_up_to(date) - scheduled_interest_up_to(date)).to_i</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line485">485</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line486">486</a>   def total_overpaid_on(date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line487">487</a>     total_received_up_to(date) - scheduled_total_up_to(date)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line488">488</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line489">489</a>   # these 3 methods return actual outstanding amounts (LOAN-OUTSTANDING perspective)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line490">490</a>   def actual_outstanding_principal_on(date)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line491">491</a>     get_actual(:balance, date)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line492">492</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line493">493</a>   def actual_outstanding_interest_on(date)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line494">494</a>     scheduled_outstanding_interest_on(date) - interest_overpaid_on(date)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line495">495</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line496">496</a>   def actual_outstanding_total_on(date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line497">497</a>     scheduled_outstanding_total_on(date) - total_overpaid_on(date)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line498">498</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line499">499</a>   def payment_dates</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line500">500</a>     payments.map { |p| p.received_on }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line501">501</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line502">502</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line503">503</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line504">504</a>   def status(date = Date.today)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line505">505</a>     get_status(date)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line506">506</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line507">507</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line508">508</a>   def get_status(date = Date.today, total_received = nil) # we have this last parameter so we can speed up get_status</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line509">509</a>                                                           # considerably by passing total_received, i.e. from history_for</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line510">510</a>     #return @status if @status</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line511">511</a>     date = Date.parse(date)      if date.is_a? String</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line512">512</a>     return :applied_in_future    if applied_on &gt; date  # non existant</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line513">513</a>     return :pending_approval     if applied_on &lt;= date and</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line514">514</a>                                  not (approved_on and approved_on &lt;= date) and</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line515">515</a>                                  not (rejected_on and rejected_on &lt;= date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line516">516</a>     return :approved             if (approved_on and approved_on &lt;= date) and not (disbursal_date and disbursal_date &lt;= date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line517">517</a>     return :rejected             if (rejected_on and rejected_on &lt;= date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line518">518</a>     return :written_off          if (written_off_on and written_off_on &lt;= date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line519">519</a>     total_received ||= total_received_up_to(date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line520">520</a>     return :disbursed          if (date == disbursal_date) and total_received &lt; total_to_be_received</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line521">521</a>     @status = total_received  &gt;= total_to_be_received ? :repaid : :outstanding</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line522">522</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line523">523</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line524">524</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line525">525</a>   # LOAN INFO FUNCTIONS - DATES</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line526">526</a>   def date_for_installment(number)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line527">527</a>     shift_date_by_installments(scheduled_first_payment_date, number-1)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line528">528</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line529">529</a>   def scheduled_maturity_date</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line530">530</a>     shift_date_by_installments(scheduled_first_payment_date, number_of_installments - 1)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line531">531</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line532">532</a>   def scheduled_repaid_on</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line533">533</a>     # first payment is on &quot;scheduled_first_payment_date&quot;, so number_of_installments-1 periods later</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line534">534</a>     # we find the scheduled_repaid_on date.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line535">535</a>     shift_date_by_installments(scheduled_first_payment_date, number_of_installments - 1)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line536">536</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line537">537</a>   # the installment dates</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line538">538</a>   def installment_dates</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line539">539</a>     (0..(number_of_installments-1)).to_a.map { |x| shift_date_by_installments(scheduled_first_payment_date, x) }</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line540">540</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line541">541</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line542">542</a>   # HISTORY</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line543">543</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line544">544</a>   # Moved this method here from instead of the LoanHistory model for purposes of speed. We sacrifice a bit of readability</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line545">545</a>   # for brute force iterations and caching =&gt; speed</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line546">546</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line547">547</a>   def update_history</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line548">548</a>     return if history_disabled  # easy when doing mass db modifications (like with fixutes)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line549">549</a>     clear_cache</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line550">550</a>     update_history_bulk_insert</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line551">551</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line552">552</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line553">553</a>   def calculate_history</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line554">554</a>     return @history_array if @history_array</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line555">555</a>     t = Time.now</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line556">556</a>     current = nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line557">557</a>     @history_array = []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line558">558</a>     dates = ([applied_on, approved_on, scheduled_disbursal_date, disbursal_date, written_off_on,scheduled_first_payment_date] + payment_dates + installment_dates).compact.uniq.sort</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line559">559</a>     last_paid_date = nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line560">560</a>     dates.each_with_index do |date,i|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line561">561</a>       current = ((dates[[i-1,0].max] &lt; Date.today and dates[[dates.size - 1,i+1].min] &gt; Date.today) or (i == dates.size - 1 and dates[i] &lt; Date.today)) ? 1 : 0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line562">562</a>       scheduled = get_scheduled(:all, date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line563">563</a>       actual = get_actual(:all, date)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line564">564</a>       # puts &quot;#{i} #{date} #{scheduled[:balance]} #{actual[:balance]} :: #{scheduled[:principal]} #{actual[:principal]}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line565">565</a>       scheduled_outstanding_principal = scheduled[:balance]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line566">566</a>       scheduled_outstanding_total = scheduled[:total_balance]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line567">567</a>       actual_outstanding_principal = actual[:balance]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line568">568</a>       actual_outstanding_total = actual[:total_balance]</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line569">569</a>       total_due = actual_outstanding_total - scheduled_outstanding_total</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line570">570</a>       principal_due = actual_outstanding_principal - scheduled_outstanding_principal</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line571">571</a>       interest_due = actual_outstanding_total - scheduled_outstanding_total - principal_due</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line572">572</a>       prin = principal_received_on(date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line573">573</a>       int = interest_received_on(date)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line574">574</a>       default = (principal_due + interest_due &gt; prin + int) and date &gt;= scheduled_first_payment_date</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line575">575</a>       if default</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line576">576</a>         last_paid_date ||= dates[[i,dates.size-1].min] </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line577">577</a>         days_overdue = [0,date - last_paid_date].max</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line578">578</a>       else</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line579">579</a>         last_paid_date = nil</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line580">580</a>         days_overdue = 0</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line581">581</a>       end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line582">582</a>       @history_array &lt;&lt; {:loan_id =&gt; id, :date =&gt; date, </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line583">583</a>                            :status =&gt; STATUSES.index(get_status(date)) + 1, </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line584">584</a>                            :scheduled_outstanding_principal =&gt; scheduled_outstanding_principal,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line585">585</a>                            :scheduled_outstanding_total =&gt; scheduled_outstanding_total,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line586">586</a>                            :actual_outstanding_principal =&gt; actual_outstanding_principal,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line587">587</a>                            :actual_outstanding_total =&gt; actual_outstanding_total,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line588">588</a>                            :amount_in_default =&gt; [0,scheduled_outstanding_principal - actual_outstanding_principal].max,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line589">589</a>                            :days_overdue =&gt; days_overdue, :current =&gt; current || 0,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line590">590</a>                            :principal_due =&gt; principal_due, :interest_due =&gt; interest_due,</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line591">591</a>                            :principal_paid =&gt; prin, :interest_paid =&gt; int}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line592">592</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line593">593</a>     Merb.logger.info &quot;History calculation took #{Time.now - t} seconds&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line594">594</a>     @history_array</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line595">595</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line596">596</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line597">597</a>   def update_history_bulk_insert</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line598">598</a>     t = Time.now</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line599">599</a>     Merb.logger.error! &quot;could not destroy the history&quot; unless self.history.destroy!</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line600">600</a>     d0 = Date.parse('2000-01-03')</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line601">601</a>     sql = %Q{ INSERT INTO loan_history(loan_id, date, status, </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line602">602</a>               scheduled_outstanding_principal, scheduled_outstanding_total,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line603">603</a>               actual_outstanding_principal, actual_outstanding_total, current, amount_in_default,</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line604">604</a>               center_id, client_id, branch_id, days_overdue, week_id, principal_due, interest_due, principal_paid, interest_paid)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line605">605</a>               VALUES }</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line606">606</a>     values = []</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line607">607</a>     calculate_history.each do |history|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line608">608</a>       value = %Q{(#{id}, '#{history[:date]}', #{history[:status]}, #{history[:scheduled_outstanding_principal]}, </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line609">609</a>                           #{history[:scheduled_outstanding_total]}, #{history[:actual_outstanding_principal]},</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line610">610</a>                           #{history[:actual_outstanding_total]},#{history[:current]},</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line611">611</a>                           #{history[:amount_in_default]}, #{client.center.id},#{client.id},#{client.center.branch.id},</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line612">612</a>                           #{history[:days_overdue]}, #{((history[:date] - d0) / 7).to_i + 1}, </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line613">613</a>                           #{history[:principal_due]},#{history[:interest_due]},</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line614">614</a>                           #{history[:principal_paid]},#{history[:interest_paid]})}</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line615">615</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line616">616</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line617">617</a>      values &lt;&lt; value</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line618">618</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line619">619</a>     sql += values.join(&quot;,&quot;) + &quot;;&quot;</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line620">620</a>     repository.adapter.execute(sql)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line621">621</a>     Merb.logger.info &quot;update_history_bulk_insert done in #{Time.now - t}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line622">622</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line623">623</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line624">624</a>   private</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line625">625</a>   include DateParser  # mixin for the hook &quot;before :valid?, :parse_dates&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line626">626</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line627">627</a>   ## validations: read their method name and error to see what they do.</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line628">628</a>   def amount_greater_than_zero?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line629">629</a>     return true if not amount.blank? and amount &gt; 0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line630">630</a>     [false, &quot;Loan amount should be greater than zero&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line631">631</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line632">632</a>   def installments_are_integers?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line633">633</a>     return [false, &quot;Number of installments not defined&quot;] if number_of_installments.nil? or number_of_installments.blank?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line634">634</a>     (1..number_of_installments).each do |i|</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line635">635</a>       p = scheduled_principal_for_installment(i)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line636">636</a>       return [false, &quot;Amount must yield integer installments&quot;] if p.to_i != p</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line637">637</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line638">638</a>     return true</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line639">639</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line640">640</a>   def interest_rate_greater_than_zero?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line641">641</a>     return true if interest_rate and interest_rate.to_f &gt; 0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line642">642</a>     [false, &quot;Interest rate should be greater than zero&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line643">643</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line644">644</a>   def number_of_installments_greater_than_zero?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line645">645</a>     return true if number_of_installments and number_of_installments.to_i &gt; 0</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line646">646</a>     [false, &quot;Number of installments should be greater than zero&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line647">647</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line648">648</a>   def applied_before_appoved?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line649">649</a>     return true if approved_on.blank? or (approved_on and applied_on and approved_on &gt;= applied_on)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line650">650</a>     [false, &quot;Cannot be approved before it is applied for&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line651">651</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line652">652</a>   def applied_before_rejected?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line653">653</a>     return true if rejected_on.blank? or (rejected_on and applied_on and rejected_on &gt;= applied_on)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line654">654</a>     [false, &quot;Cannot be rejected before it is applied for&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line655">655</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line656">656</a>   def approved_before_disbursed?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line657">657</a>     return true if disbursal_date.blank? or (disbursal_date and approved_on and disbursal_date &gt;= approved_on)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line658">658</a>     [false, &quot;Cannot be disbursed before it is approved&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line659">659</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line660">660</a>   def disbursed_before_validated?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line661">661</a>     return true if validated_on.blank? or (disbursal_date and validated_on and disbursal_date &lt;= validated_on)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line662">662</a>     [false, &quot;Cannot be validated before it is disbursed&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line663">663</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line664">664</a>   def disbursed_before_written_off?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line665">665</a>     return true if written_off_on.blank? or (disbursal_date and written_off_on and disbursal_date &lt;= written_off_on)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line666">666</a>     [false, &quot;Cannot be written off before it is disbursed&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line667">667</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line668">668</a>   def applied_before_scheduled_to_be_disbursed?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line669">669</a>     return true if scheduled_disbursal_date and applied_on and scheduled_disbursal_date &gt;= applied_on</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line670">670</a>     [false, &quot;Cannot be scheduled for disbusal before it is applied&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line671">671</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line672">672</a>   def scheduled_disbursal_before_scheduled_first_payment?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line673">673</a>     return true if scheduled_disbursal_date and scheduled_first_payment_date and scheduled_disbursal_date &lt;= scheduled_first_payment_date</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line674">674</a>     [false, &quot;The scheduled first payment date cannot precede the scheduled disbursal date&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line675">675</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line676">676</a>   def properly_approved?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line677">677</a>     return true if (approved_on and approved_by) or (approved_on.blank? and approved_by.blank?)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line678">678</a>     [false, &quot;The approval date and the staff member that approved the loan should both be given&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line679">679</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line680">680</a>   def properly_rejected?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line681">681</a>     return true if (rejected_on and rejected_by) or (rejected_on.blank? and rejected_by.blank?)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line682">682</a>     [false, &quot;The rejection date and the staff member that rejected the loan should both be given&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line683">683</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line684">684</a>   def properly_written_off?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line685">685</a>     return true if (written_off_on and written_off_by) or (written_off_on.blank? and written_off_by.blank?)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line686">686</a>     [false, &quot;The date of writing off the loan and the staff member that wrote off the loan should both be given&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line687">687</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line688">688</a>   def properly_disbursed?</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line689">689</a>     return true if (disbursal_date and disbursed_by) or (disbursal_date.blank? and disbursed_by.blank?)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line690">690</a>     [false, &quot;The disbursal date and the staff member that disbursed the loan should both be given&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line691">691</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line692">692</a>   def properly_validated?</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line693">693</a>     # if the validation_comment is not blank we also invalidate the model</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line694">694</a>     return true if (validated_on and validated_by) or (validated_on.blank? and validated_by.blank? and validation_comment.blank?)</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line695">695</a>     [false, &quot;The validation date, the validating staff member the loan should both be given&quot;]</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line696">696</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line697">697</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line698">698</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line699">699</a>   # this method only works if fees are in a format of:</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line700">700</a>   #   &quot;fee1: 100\nfee2: 200&quot;:String (yaml)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line701">701</a>   # and gets called from the free= method, yet all this is fully reimplementable</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line702">702</a>   def update_fees_total</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line703">703</a>     return if fees.blank?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line704">704</a>     total = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line705">705</a>     fees = YAML.load(self.fees) if self.fees.is_a? String</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line706">706</a>     fees.each_value { |v| total += v.to_i }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line707">707</a>     self.fees_total = total</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line708">708</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line709">709</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line710">710</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line711">711</a>   def update_status # DEPRECATED? check if this is actually being called. I think we moved this to loan_history with</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line712">712</a>                     # a 'current' flag.</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line713">713</a>     self.status = history[:status]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line714">714</a>     if not payments.empty?</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line715">715</a>       self.last_payment_received_on = payments.all(:order =&gt; [:received_on.desc]).first.received_on</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line716">716</a>     end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line717">717</a>     self.amount_in_default = history[:actual_outstanding_principal] - history[:scheduled_outstanding_principal]</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line718">718</a>     self.history_disabled = true</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line719">719</a>     Merb.logger.notice! &quot;Saving loan #{id}&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line720">720</a>     self.save</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line721">721</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line722">722</a>   </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line723">723</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line724">724</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line725">725</a> end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line726">726</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line727">727</a> class DefaultLoan &lt; Loan</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line728">728</a>   # This is the &quot;Default&quot; loan type. It is nothing better of worse than its parent.</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line729">729</a>   # That explains the emptyness</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line730">730</a>   def self.description</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line731">731</a>     &quot;This is the default loan in Mostfit. In this loan type interest is is paid flat over the installments, so all the installments are the same size. It allows both repayment in totals and repayment in principal-interest pairs. In case of paying in totals the interest due is payed before the principal due.&quot;</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line732">732</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line733">733</a>   def fields_partial</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line734">734</a>     ''  # this method is are used plug HTML into the show page of the loan and its payments (app/views/payments/index.html.haml)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line735">735</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line736">736</a>   def show_partial</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line737">737</a>     ''  # this method is are used plug HTML into the show page of the loan and its payments (app/views/payments/index.html.haml)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line738">738</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line739">739</a> end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line740">740</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line741">741</a> class A50Loan &lt; Loan</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line742">742</a>   # a fine example of a subclassing (if it was finished)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line743">743</a>   # these 2 methods define the pay back scheme</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line744">744</a>   # typically reimplemented in subclasses</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line745">745</a>   property :purpose,  String</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line746">746</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line747">747</a>   attr_accessor :defaults</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line748">748</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line749">749</a>   def defaults</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line750">750</a>     {:interest_rate =&gt; 0.18, :installment_frequency =&gt; :weekly, :number_of_installments =&gt; 50}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line751">751</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line752">752</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line753">753</a>   def self.description</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line754">754</a>     &quot;50 Weeks, 18%, [6000-10000]&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line755">755</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line756">756</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line757">757</a>   def scheduled_principal_for_installment(number)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line758">758</a>     # number unused in this implentation, subclasses may decide differently</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line759">759</a>     # therefor always supply number, so it works for all implementations</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line760">760</a>     raise &quot;number out of range, got #{number}&quot; if number &lt; 0 or number &gt; number_of_installments - 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line761">761</a>     amount.to_f / number_of_installments</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line762">762</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line763">763</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line764">764</a>   def scheduled_interest_for_installment(number)  # typically reimplemented in subclasses</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line765">765</a>     # number unused in this implentation, subclasses may decide differently</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line766">766</a>     # therefor always supply number, so it works for all implementations</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line767">767</a>     raise &quot;number out of range, got #{number}&quot; if number &lt; 0 or number &gt; number_of_installments - 1</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line768">768</a>     number &lt; 45 ? total_interest_to_be_received / 45 : 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line769">769</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line770">770</a> end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line771">771</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line772">772</a> class EquatedWeekly &lt; Loan</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line773">773</a>   # these 2 methods define the pay back scheme</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line774">774</a>   # typically reimplemented in subclasses</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line775">775</a>   include ExcelFormula</pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line776">776</a>   property :purpose,  String</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line777">777</a>   </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line778">778</a>   attr_accessor :defaults</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line779">779</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line780">780</a>   def defaults</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line781">781</a>     {:interest_rate =&gt; 0.18, :installment_frequency =&gt; :weekly, :number_of_installments =&gt; 50}</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line782">782</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line783">783</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line784">784</a>   def self.description</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line785">785</a>     &quot;50 Weeks, 18%, [6000-10000]&quot;</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line786">786</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line787">787</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line788">788</a>   def scheduled_principal_for_installment(number)</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line789">789</a>     # number unused in this implentation, subclasses may decide differently</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line790">790</a>     # therefor always supply number, so it works for all implementations</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line791">791</a>     raise &quot;number out of range, got #{number} but max is #{number_of_installments}&quot; if number &lt; 0 or number &gt; number_of_installments</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line792">792</a>     payment             = pmt(interest_rate/number_of_installments, number_of_installments, amount, 0, 0)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line793">793</a>     principal_payable   = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line794">794</a>     balance             = amount</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line795">795</a> </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line796">796</a>     1.upto(number){|installment|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line797">797</a>       interest_payable  = balance * interest_rate / number_of_installments</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line798">798</a>       principal_payable = payment - interest_payable</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line799">799</a>       balance           = balance - principal_payable</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line800">800</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line801">801</a>     return number==number_of_installments ? balance.ceil : principal_payable.to_i</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line802">802</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line803">803</a> </pre></td>
          </tr>
        
          
          
          <tr class="marked">
            <td><pre><a name="line804">804</a>   def scheduled_interest_for_installment(number)  # typically reimplemented in subclasses</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line805">805</a>     # number unused in this implentation, subclasses may decide differently</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line806">806</a>     # therefor always supply number, so it works for all implementations</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line807">807</a>     raise &quot;number out of range, got #{number}&quot; if number &lt; 0 or number &gt; number_of_installments</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line808">808</a>     payment             = pmt(interest_rate/number_of_installments, number_of_installments, amount, 0, 0)</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line809">809</a>     interest_payable    = 0</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line810">810</a>     balance             = amount</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line811">811</a>     </pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line812">812</a>     1.upto(number){|installment|</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line813">813</a>       interest_payable  = balance * interest_rate / number_of_installments</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line814">814</a>       principal_payable = payment - interest_payable</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line815">815</a>       balance           = balance - principal_payable</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line816">816</a>     }</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line817">817</a>     return interest_payable.to_i</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line818">818</a>   end</pre></td>
          </tr>
        
          
          
          <tr class="uncovered">
            <td><pre><a name="line819">819</a> end</pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line820">820</a> </pre></td>
          </tr>
        
          
          
          <tr class="inferred">
            <td><pre><a name="line821">821</a> </pre></td>
          </tr>
        
      </tbody>
    </table>

    <p>Generated on Thu Nov 12 16:05:07 +0530 2009 with <a href="http://github.com/relevance/rcov">rcov 0.9.6</a></p>

  </body>
</html>
